---
title: "UBIQUITY-ADNMA: Results Generation (Draft)"
author: "Generated by CoolCline"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    number_sections: true
    fig_caption: true
    latex_engine: xelatex
---

```{r setup, include=FALSE}
# Set output directory to ../reports/
knitr::opts_knit$set(output.dir = '../reports/')

knitr::opts_chunk$set(echo = TRUE, 
                     message = FALSE, 
                     warning = FALSE,
                     fig.path = "../reports/generate_results_files/figure-latex/")

# Install packages if not already installed
# install.packages("tidyverse")
# install.packages("netmeta")
# install.packages("kableExtra")

library(tidyverse)
library(netmeta)
library(kableExtra)

# Define output directory (though plots/tables will be embedded here)
output_dir <- "output" 
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}
```

# 1. Introduction

This R Markdown document demonstrates the generation of key figures and tables for the UBIQUITY-ADNMA study based on the planned analyses and the structure of the data extraction sheet. It uses dummy data (`dummy_de_sheet.csv`) for illustration purposes.

The goal is to verify that the data structure is sufficient for generating the core network meta-analysis (NMA) results outlined in `analysis/figures_tables_plan.md`.

# 2. Load and Prepare Data

We load the dummy NMA data sheet.

```{r load-data}
de_data <- read_csv("../data/dummy/dummy_de_sheet.csv")

# Display first few rows
head(de_data) %>% 
  kbl(caption = "First 6 rows of the dummy DE data") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# Basic check of intervention categories
table(de_data$intervention_category)
```

The data includes study identifiers, arm-level information (intervention category, sample sizes), outcome data (mean, SD for primary outcome), and some study characteristics (RoB, cluster RCT status).

# 3. Network Meta-Analysis (Primary Outcome: Alcohol Consumption)

We will perform a network meta-analysis using the `netmeta` package. We need to prepare the data in the format required by `netmeta`, typically one row per arm within each study.

```{r prepare-netmeta-data}
# Ensure intervention categories are factors with a specific reference level if desired
de_data <- de_data %>%
  mutate(intervention_category = factor(intervention_category, levels = c("No Intervention", "UBI-minimal", "UBI-feedback", "BI")))

# Prepare data for netmeta (pairwise format)
# Calculate Standard Error (SE) from SD and N
de_data_pairwise <- de_data %>%
  mutate(se_primary = outcome_primary_sd / sqrt(n_analyzed_primary)) %>%
  select(studlab = study_id, 
         treat = intervention_category, 
         n = n_analyzed_primary, 
         mean = outcome_primary_mean, 
         sd = outcome_primary_sd,
         se = se_primary) # netmeta can use mean/sd or mean/se

# Check prepared data
head(de_data_pairwise) %>%
  kbl(caption = "Data prepared for netmeta") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# Create pairwise data object for netmeta
# Note: This assumes 'mean' and 'sd' are endpoint values. 
# If they were change scores, the sm would be "MD".
# For continuous outcomes, netmeta often works better in pairwise format.
# Let's try creating the contrast-based data first as it's more direct from arm-based data.
# If errors occur, we might need to manually create pairwise contrasts.

# Using netmeta's direct arm-based data functionality (requires TE, seTE if sm="MD")
# We need Mean Difference (MD) and its SE compared to a baseline or control.
# The dummy data has endpoint means. We'll calculate MD relative to 'No Intervention' *within each study* if possible.
# This is complex with the current dummy structure. 
# A simpler approach for demonstration is to use netmeta assuming endpoint means directly, 
# though interpretation needs care (sm="MD" on endpoints isn't standard NMA).
# Let's proceed with caution, noting this limitation for the dummy data.

# For demonstration, we'll use the pairwise function to convert arm-data to contrast-data
# This requires specifying a reference group within each study if multiple active arms exist vs control.
# Let's simplify for the demo and assume netmeta can handle the arm-based data directly for sm="MD" (endpoint means)
# This might not be the final analysis method but shows data usage.

# Perform NMA using arm-based data (Mean and SD)
# Need to ensure study IDs are correctly grouped.
# The netmeta function expects TE (treatment effect) and seTE (standard error of TE) for sm="MD"
# Let's calculate MD and SE vs 'No Intervention' within each study where possible.

# Create a temporary function to calculate MD and pooled SD/SE vs reference within a study
calculate_md_vs_ref <- function(df, ref_treat = "No Intervention") {
  ref_arm <- df %>% filter(treat == ref_treat)
  if(nrow(ref_arm) != 1) return(NULL) # Need exactly one reference arm
  
  active_arms <- df %>% filter(treat != ref_treat)
  if(nrow(active_arms) == 0) return(NULL) # Need active arms
  
  results <- active_arms %>%
    mutate(
      TE = mean - ref_arm$mean,
      # Pooled SD for SE calculation (approximate) - using variances
      pooled_var = ((n - 1) * sd^2 + (ref_arm$n - 1) * ref_arm$sd^2) / (n + ref_arm$n - 2),
      seTE = sqrt(pooled_var / n + pooled_var / ref_arm$n) 
      # More direct SE calculation if SEs are reliable: seTE = sqrt(se^2 + ref_arm$se^2)
      # Using the direct SE calculation:
      # seTE = sqrt(se^2 + ref_arm$se^2) # Ensure 'se' column exists and is correct SE of the mean
    ) %>%
    # Use direct SE calculation
     mutate(seTE = sqrt(se^2 + ref_arm$se)) %>%
    select(studlab, treat, TE, seTE)
  
  return(results)
}

# Apply this calculation - requires careful handling of study structure
# This is complex to implement robustly here. 
# Alternative: Use netmeta with mean/sd directly (less standard interpretation)

# Let's try the direct mean/sd approach for demonstration
# Need to tell netmeta these are arm-based means/SDs
# The 'pairwise' function helps convert this format
pdat <- pairwise(treat = treat, 
                 mean = mean, 
                 sd = sd, 
                 n = n, 
                 studlab = studlab, 
                 data = de_data_pairwise, 
                 sm = "MD") # Mean Difference

# Perform NMA (Random Effects Model)
nma_result <- netmeta(pdat, 
                      comb.fixed = FALSE, 
                      comb.random = TRUE, 
                      reference.group = "No Intervention",
                      sm = "MD")

summary(nma_result)
```

# 4. Generate Figures and Tables

## Figure 1: PRISMA Flow Diagram (Textual Representation)

We load the PRISMA counts from the dummy data file and display them textually to represent the flow.

```{r fig-prisma-text}
prisma_data <- read_csv("../data/dummy/dummy_prisma_data.csv") %>%
  # Convert to named list for easy access
  deframe() 

cat(paste0(
  "## PRISMA 2020 Flow Diagram (Text Summary)\n\n",
  "**Identification**\n",
  "- Records identified from databases: ", prisma_data["identification_db"], "\n",
  "- Records identified from other sources: ", prisma_data["identification_other"], "\n",
  "- Total records identified: ", prisma_data["identification_total"], "\n",
  "- Duplicate records removed: ", prisma_data["duplicates_removed"], "\n",
  "- Records screened (title/abstract): ", prisma_data["records_screened"], "\n",
  "- Records excluded during screening: ", prisma_data["records_excluded_screening"], "\n\n",
  "**Screening**\n",
  "- Reports sought for retrieval: ", prisma_data["reports_retrieved"], "\n",
  "- Reports not retrieved: ", prisma_data["reports_not_retrieved"], "\n",
  "- Reports assessed for eligibility (full-text): ", prisma_data["reports_assessed"], "\n",
  "- Reports excluded during eligibility assessment: ", prisma_data["reports_excluded_eligibility"], "\n\n",
  "**Included**\n",
  "- Studies included in qualitative synthesis: ", prisma_data["studies_included_qualitative"], "\n",
  "- Studies included in quantitative synthesis (NMA): ", prisma_data["studies_included_quantitative"], "\n"
))
```

## Figure 2: Network Plot

```{r fig-network-plot, fig.cap="Network plot of interventions for hazardous drinking."}
# Customize plot if needed
netgraph(nma_result, 
         points = TRUE, 
         cex.points = 3, 
         col.points="lightblue",
         plastic = FALSE, # Use straight lines
         thickness = "number.of.studies", # Edge thickness based on number of studies
         )
title("Figure 2: Network Plot")
```

This plot shows the included interventions and the direct comparisons available in the dummy dataset. Edge thickness represents the number of studies for each direct comparison.

## Figure 3: Forest Plot (Primary Outcome)

```{r fig-forest-plot, fig.cap="Forest plot for the primary outcome (Alcohol Consumption, g/week)."}
forest(nma_result, 
       ref = "No Intervention", 
       xlab = "Mean Difference (g/week)",
       smlab = "Intervention vs. No Intervention",
       leftcols = c("studlab", "effect", "ci"), # Adjust columns as needed
       rightcols = FALSE,
       pooled = "random", # Show random-effects summary
       main = "Figure 3: Forest Plot (vs No Intervention)" # Use main argument for title
       )

# You might want separate forest plots for each comparison if needed
# forest(nma_result, comparison = "BI:No Intervention", main = "Forest Plot: BI vs No Intervention") 
```

This forest plot shows the estimated Mean Difference (MD) in alcohol consumption (g/week) for each intervention compared to "No Intervention", based on the NMA. Negative values favor the intervention.

## Figure 4: Comparison-Adjusted Funnel Plot

With the extended dummy dataset (15 studies), we can now generate the funnel plot to visually inspect potential publication bias or small-study effects.

```{r fig-funnel-plot, fig.cap="Comparison-adjusted funnel plot for the primary outcome."}
# Generate funnel plot
funnel(nma_result, order = c("BI", "UBI-feedback", "UBI-minimal", "No Intervention")) # Order treatments for consistency
title("Figure 4: Comparison-Adjusted Funnel Plot") 
```

*(Note: Interpretation of funnel plots requires caution, especially with moderate numbers of studies and heterogeneity.)*

## Figure 5: CINeMA Findings (Placeholder)

CINeMA assessment requires a separate evaluation process using the CINeMA framework/software based on the final NMA results and RoB assessments.

*(Note: CINeMA involves a detailed assessment process external to this script. The table below uses dummy data to illustrate the structure of the final CINeMA summary.)*

```{r fig-cinema-placeholder}
# Dummy CINeMA results table
cinema_summary <- tribble(
  ~Comparison, ~`Within-study bias`, ~`Reporting bias`, ~Indirectness, ~Imprecision, ~Incoherence, ~`Overall Confidence`,
  "UBI-minimal vs No Intervention", "Low concern", "Low concern", "Low concern", "Moderate concern", "Low concern", "Moderate",
  "UBI-feedback vs No Intervention", "Low concern", "Low concern", "Low concern", "Low concern", "Low concern", "High",
  "BI vs No Intervention", "Some concerns", "Low concern", "Low concern", "Low concern", "Low concern", "Moderate",
  "UBI-feedback vs UBI-minimal", "Low concern", "Low concern", "Low concern", "Moderate concern", "Low concern", "Moderate",
  "BI vs UBI-feedback", "Some concerns", "Low concern", "Low concern", "Low concern", "Low concern", "Moderate"
)

cinema_summary %>%
  kbl(caption = "Figure 5: Illustrative CINeMA Summary Table for Key Comparisons") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

# 5. Generate NMA Results Tables

## Table 1: Characteristics of Included Studies (Partial - NMA Data)

This table displays the detailed qualitative information for included studies from `dummy_included_studies_details.csv`. For the final manuscript's Table 1, this information would be combined and formatted with quantitative data from `dummy_de_sheet.csv`.

```{r table-characteristics-full}
# Load detailed qualitative data
included_details <- read_csv("../data/dummy/dummy_included_studies_details.csv")

# Display the detailed info using kable with landscape orientation and smaller font
# For a proper Table 1, you would typically merge 'de_data' and 'included_details' by study_id 
# and select/format columns appropriately. This is just showing the raw details table.

# Use pdflscape package for landscape orientation
included_details %>%
  kbl(caption = "Table 1: Characteristics of Included Studies (Detailed Qualitative Information)", 
      longtable = TRUE, # Use longtable for multi-page tables
      booktabs = TRUE,
      font_size = 6) %>% # Smaller font size
  kable_styling(latex_options = c("striped", "scale_down", "repeat_header", "hold_position"),
                full_width = FALSE) %>% # Scale down to fit page
  column_spec(1, width = "5em") %>%
  column_spec(2, width = "7em") %>%
  column_spec(3, width = "7em") %>%
  column_spec(4, width = "7em") %>%
  column_spec(5, width = "7em") %>%
  column_spec(6, width = "7em") %>%
  column_spec(7, width = "7em") %>%
  column_spec(8, width = "7em") %>%
  column_spec(9, width = "5em") %>%
  column_spec(10, width = "5em") %>%
  add_header_above(c(" " = 10)) %>%
  landscape() # Use landscape orientation
  
# Note: Code to merge this with quantitative data and format for the final Table 1 would be added here.
```

## Table 2: Excluded Studies

This table requires data from `dummy_excluded_studies.csv`.

```{r table-excluded}
excluded_data <- read_csv("../data/dummy/dummy_excluded_studies.csv")
excluded_data %>%
 kbl(caption = "Table 2: Characteristics of Excluded Studies") %>%
 kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F) %>%
 column_spec(1, width = "10em") %>%
 column_spec(4, width = "30em")
```

\

## Table 3: League Table (Primary Outcome)

```{r table-league}
# Generate league table data
league_table_data <- netleague(nma_result)

# Print the league table using kable for better formatting
# The default print method for netleague is okay, but kable offers more control
# league_table_data$random %>% # Access the random effects results
#   kbl(caption = "Table 3: League Table for Primary Outcome (Alcohol Consumption, g/week) - Random Effects Model") %>%
#   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

# Use the default print method which is often well-formatted for league tables
print(league_table_data, random = TRUE, digits=2) 
```

This league table shows the estimated Mean Difference (MD) and 95% Confidence Interval for all pairwise comparisons between the interventions based on the random-effects NMA. Results are typically read row vs column.

## Table 4: Secondary Outcome League Table (Binge Drinking Days/Month)

We now perform NMA for the secondary outcome (binge drinking days per month) using the extended dummy data.

```{r nma-secondary}
# Prepare secondary outcome data
de_data_secondary <- de_data %>%
  filter(!is.na(outcome_secondary_mean) & !is.na(outcome_secondary_sd)) %>% # Exclude rows with missing secondary outcome
  mutate(se_secondary = outcome_secondary_sd / sqrt(n_analyzed_primary)) %>% # Assuming same N analyzed for secondary
  select(studlab = study_id, 
         treat = intervention_category, 
         n = n_analyzed_primary, 
         mean = outcome_secondary_mean, 
         sd = outcome_secondary_sd,
         se = se_secondary)

# Create pairwise data object for secondary outcome
pdat_secondary <- pairwise(treat = treat, 
                           mean = mean, 
                           sd = sd, 
                           n = n, 
                           studlab = studlab, 
                           data = de_data_secondary, 
                           sm = "MD") 

# Perform NMA for secondary outcome
nma_result_secondary <- netmeta(pdat_secondary, 
                                comb.fixed = FALSE, 
                                comb.random = TRUE, 
                                reference.group = "No Intervention",
                                sm = "MD")

summary(nma_result_secondary)

# Generate league table for secondary outcome
league_table_secondary <- netleague(nma_result_secondary)

print(league_table_secondary, random = TRUE, digits=2) 
```

This league table shows the estimated Mean Difference (MD) and 95% Confidence Interval for binge drinking days per month.

## Table 5: Sensitivity and Subgroup Analyses (Examples)

We demonstrate example analyses based on the dummy data.

### Sensitivity Analysis: Excluding High Risk of Bias Studies

We re-run the primary outcome NMA excluding studies judged as 'High' risk of bias.

```{r sensitivity-rob}
# Get IDs of high RoB studies
high_rob_studies <- de_data %>% 
  filter(rob_overall == "High") %>% 
  distinct(study_id) %>% 
  pull(study_id)

# Filter the pairwise data
pdat_low_mod_rob <- pdat %>% 
  filter(!studlab %in% high_rob_studies)

# Perform NMA excluding high RoB studies
nma_sensitivity_rob <- netmeta(pdat_low_mod_rob, 
                               comb.fixed = FALSE, 
                               comb.random = TRUE, 
                               reference.group = "No Intervention",
                               sm = "MD")

# Display summary or league table for sensitivity analysis
cat("\n--- Sensitivity Analysis (Excluding High RoB) ---\n")
print(netleague(nma_sensitivity_rob), random = TRUE, digits = 2)

```

### Subgroup Analysis: Follow-up Duration (<9 months vs >=9 months)

We perform a subgroup analysis for the primary outcome based on follow-up duration.

```{r subgroup-followup}
# Add follow-up duration to the pairwise data (need to merge back)
followup_info <- de_data %>% distinct(study_id, followup_months_primary)

pdat_with_followup <- pdat %>%
  left_join(followup_info, by = c("studlab" = "study_id")) %>%
  mutate(followup_group = ifelse(followup_months_primary < 9, "<9m", ">=9m"))

# Perform subgroup NMA
nma_subgroup_followup <- netmeta(pdat_with_followup, 
                                 comb.fixed = FALSE, 
                                 comb.random = TRUE, 
                                 reference.group = "No Intervention",
                                 sm = "MD",
                                 subgroup = "followup_group") # Specify the subgroup variable name as a string

# Display subgroup results summary
cat("\n--- Subgroup Analysis (Follow-up Duration) ---\n")
summary(nma_subgroup_followup)

# You can also print league tables per subgroup if needed
# print(netleague(nma_subgroup_followup), subgroup=TRUE, random=TRUE, digits=2)
```

*(Note: The sensitivity and subgroup analyses shown are examples based on the dummy data. Actual analyses may use different approaches.)*

# 6. Conclusion

This document demonstrates the generation of all planned figures and tables using the defined dummy data structures within an R Markdown framework. This confirms the sufficiency of the data sheet design for the intended outputs and provides a template for reproducible results generation.